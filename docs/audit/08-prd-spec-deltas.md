# 08. PRD 변경사항 (PRD Spec Deltas)

> 감사 결과 발견된 누락/추가/변경이 필요한 PRD 요구사항

---

## 1. 신규 기능 요구사항 (New Features)

### FR-001: 메시지 편집 기능

**우선순위**: Phase 1 (필수)

**설명**: 사용자가 보낸 메시지를 편집할 수 있는 기능

**요구사항**:
1. 본인이 보낸 메시지만 편집 가능
2. 메시지 발송 후 24시간 이내만 편집 가능
3. 편집된 메시지에 "편집됨" 표시
4. 편집 기록 보존 (히스토리)
5. 미디어 메시지는 편집 불가 (텍스트만)

**영향 범위**:
- `lib/data/models/broadcast_message.dart` (모델 수정 - 이미 필드 존재)
- `lib/features/chat/widgets/message_bubble.dart` (편집됨 표시 추가)
- `lib/features/chat/widgets/message_edit_dialog.dart` (신규)
- `supabase/functions/message-edit/` (신규 Edge Function)

---

### FR-002: 메시지 삭제 기능

**우선순위**: Phase 1 (필수)

**설명**: 사용자가 보낸 메시지를 삭제할 수 있는 기능

**요구사항**:
1. 본인이 보낸 메시지만 삭제 가능
2. 삭제된 메시지는 상대방에게 "삭제된 메시지입니다" 표시
3. 삭제 후 복구 불가 (soft delete)
4. 삭제 시 확인 다이얼로그 표시

**영향 범위**:
- `lib/data/models/broadcast_message.dart` (deletedAt 필드 사용)
- `lib/features/chat/widgets/message_bubble.dart` (삭제됨 UI)
- `supabase/migrations/` (삭제 정책 추가)

---

### FR-003: 신고 기능

**우선순위**: Phase 1 (필수 - 앱스토어 정책)

**설명**: 부적절한 콘텐츠/사용자를 신고하는 기능

**요구사항**:
1. 메시지, 프로필, 캠페인 신고 가능
2. 신고 사유 선택 필수 (스팸, 괴롭힘, 부적절한 콘텐츠, 사기, 저작권, 기타)
3. 추가 설명 입력 (선택)
4. 동일 대상 24시간 내 중복 신고 불가
5. 신고 접수 확인 메시지 표시
6. 신고 처리 결과 알림 (이메일 또는 푸시)

**영향 범위**:
- `supabase/migrations/017_add_reports_table.sql` (신규)
- `lib/features/chat/widgets/report_dialog.dart` (신규)
- `lib/data/repositories/report_repository.dart` (신규)
- 어드민 패널 신고 관리 (Phase 1-E)

---

### FR-004: 차단 기능

**우선순위**: Phase 1 (필수 - 앱스토어 정책)

**설명**: 특정 사용자를 차단하는 기능

**요구사항**:
1. 사용자 차단 시 해당 사용자의 메시지 숨김
2. 차단 목록 관리 (조회/해제)
3. 차단 해제 시 이전 메시지 다시 표시
4. 자기 자신 차단 불가
5. 차단 시 확인 다이얼로그

**영향 범위**:
- `supabase/migrations/018_add_blocks_table.sql` (신규)
- `lib/features/settings/blocked_users_screen.dart` (신규)
- `lib/data/repositories/block_repository.dart` (신규)
- 메시지 조회 RLS 정책 수정

---

### FR-005: 푸시 알림 시스템

**우선순위**: Phase 1 (필수)

**설명**: 주요 이벤트에 대한 푸시 알림

**요구사항**:
1. 알림 유형:
   - 새 브로드캐스트 메시지
   - 팬 답장 (크리에이터)
   - 펀딩 업데이트
   - 정산 완료
   - 시스템 공지
2. 알림 설정 (유형별 on/off)
3. 방해금지 시간 설정 (Phase 2)
4. 딥링크로 관련 화면 이동

**영향 범위**:
- `lib/services/fcm_service.dart` (완성)
- `supabase/functions/send-notification/` (신규)
- `lib/features/settings/notification_settings_screen.dart` (수정)

---

### FR-006: 어드민 패널 MVP

**우선순위**: Phase 1 (필수)

**설명**: 플랫폼 운영을 위한 관리자 도구

**요구사항**:
1. 대시보드
   - 실시간 사용자 수
   - 오늘 결제액
   - 대기중인 심사/신고 건수
2. 캠페인 심사
   - 심사 대기 목록
   - 상세 검토 화면
   - 승인/반려/수정요청 액션
3. 신고 관리
   - 신고 목록 (우선순위 정렬)
   - 상세 검토 화면
   - 조치 (경고/정지/영정)
4. 감사로그 조회
   - 필터 (날짜, 액션, 대상)
   - 검색

**영향 범위**:
- `apps/web/app/(admin)/` (신규 전체)
- 기존 RLS 정책에 어드민 권한 추가

---

### FR-007: 결제 연동 완성

**우선순위**: Phase 1 (필수)

**설명**: TossPayments 결제 연동 완성

**요구사항**:
1. DT 구매 결제
   - 결제 요청 생성
   - 결제 완료 처리 (웹훅)
   - 결제 실패 처리
2. 구독 결제
   - 첫 결제
   - 자동 갱신 (Phase 2)
3. 환불
   - 환불 요청 API
   - 환불 처리 상태 표시
4. 결제 내역 조회

**영향 범위**:
- `supabase/functions/payment-checkout/` (완성)
- `supabase/functions/payment-webhook/` (환불 처리 추가)
- `lib/features/wallet/dt_charge_screen.dart` (연동)

---

## 2. 기능 변경 요구사항 (Changed Features)

### CR-001: 빈상태/에러상태 표준화

**우선순위**: Phase 1

**변경 내용**: 모든 화면에 일관된 빈상태/에러상태 표시

**AS-IS**:
- 일부 화면에만 적용
- 디자인 불일치

**TO-BE**:
- `EmptyState` 위젯으로 통일
- `ErrorDisplay` 위젯으로 통일
- `LoadingState` 위젯으로 통일

---

### CR-002: 메시지 액션 시트

**우선순위**: Phase 1

**변경 내용**: 메시지 롱프레스 시 액션 시트 표시

**AS-IS**:
- 롱프레스 시 아무 반응 없음

**TO-BE**:
```
본인 메시지:
- 편집 (24시간 이내)
- 삭제
- 복사

타인 메시지:
- 복사
- 신고
- 차단
```

---

### CR-003: 읽음 표시 UI

**우선순위**: Phase 1

**변경 내용**: 메시지 읽음 상태 시각적 표시

**AS-IS**:
- `isRead` 필드 있으나 UI 없음

**TO-BE**:
- 보낸 메시지 옆에 체크 아이콘
- 단일 체크: 전송됨
- 이중 체크: 읽음

---

### CR-004: 전송 상태 표시

**우선순위**: Phase 1

**변경 내용**: 메시지 전송 중/실패 상태 표시

**AS-IS**:
- 전송 후 즉시 목록에 추가

**TO-BE**:
- 전송 중: 회색 + 시계 아이콘
- 전송 실패: 빨간색 + 경고 아이콘 + 재전송 버튼

---

## 3. 비기능 요구사항 (Non-Functional Requirements)

### NFR-001: 보안 - 암호화 키 관리

**우선순위**: Phase 0 (즉시)

**요구사항**:
1. 암호화 키 fallback 제거
2. 키 미설정 시 서비스 시작 실패
3. 키 로테이션 절차 문서화

---

### NFR-002: 보안 - 감사로그 무결성

**우선순위**: Phase 0 (즉시)

**요구사항**:
1. 감사로그 INSERT는 서비스 계정 또는 어드민만 가능
2. UPDATE/DELETE 불가 (append-only)
3. 로그 보존 기간: 최소 3년

---

### NFR-003: Rate Limiting

**우선순위**: Phase 1

**요구사항**:
| 엔드포인트 | 제한 |
|-----------|------|
| 메시지 전송 | 30회/분/사용자 |
| 결제 웹훅 | 100회/분/IP |
| 본인인증 | 5회/분/사용자 |
| 신고 | 10회/시간/사용자 |

---

### NFR-004: 에러 모니터링

**우선순위**: Phase 1

**요구사항**:
1. Sentry 에러 캡처 활성화
2. 사용자 컨텍스트 포함
3. 중요 에러 Slack 알림
4. 에러율 대시보드

---

### NFR-005: 성능 - 메시지 로딩

**우선순위**: Phase 1

**요구사항**:
1. 초기 로딩: 50개 메시지
2. 추가 로딩: 무한 스크롤
3. 이미지 lazy loading
4. 메시지 캐싱 (로컬)

---

## 4. 법적/정책 요구사항 (Compliance Requirements)

### COM-001: 필수 약관

**우선순위**: Phase 0 (필수)

**요구사항**:
1. 서비스 이용약관
2. 개인정보처리방침
3. 환불 정책
4. 커뮤니티 가이드라인

---

### COM-002: 앱스토어 정책 준수

**우선순위**: Phase 1

**요구사항**:
1. 신고/차단 기능 (UGC 플랫폼 필수)
2. 연령 제한 설정
3. 개인정보 링크 제공
4. 데이터 안전 섹션 (Google Play)

---

### COM-003: 미성년자 보호

**우선순위**: Phase 1

**요구사항**:
1. 만 14세 미만 가입 불가
2. 만 19세 미만 결제 한도
3. 법정대리인 동의 절차
4. 연령 확인 재검증 (결제 시)

---

## 5. 삭제/보류 요구사항 (Removed/Deferred)

### DEF-001: 라이브 스트리밍

**보류 사유**: 기술 복잡도 및 비용
**재검토 시점**: Phase 3

---

### DEF-002: 스티커/커스텀 이모지

**보류 사유**: 핵심 기능 아님
**재검토 시점**: Phase 2

---

### DEF-003: 일정 공유

**보류 사유**: 핵심 기능 아님
**재검토 시점**: Phase 3

---

## 6. PRD 변경 이력

| 날짜 | 버전 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 2025-02-05 | 1.1 | 감사 기반 요구사항 추가 (FR-001~007, CR-001~004, NFR-001~005, COM-001~003) | Claude Audit |
| - | 1.0 | 초기 PRD | - |
