---
name: API Master
description: 외부 API(KIS, DART, Gemini 등) 통합 시나리오에서 인증 처리, 토큰 관리, API 한도(Rate Limit) 준수 패턴을 정의합니다.
---

# 외부 API 통합 및 토큰 관리 스킬 (API Master)

이 스킬은 인증 및 보안, 제약 사항이 까다로운 외부 API(예: 한국투자증권, DART, Gemini 등)를 사용할 때 일관되고 견고한(Robust) 방식으로 연결하기 위해 사용됩니다.

## 🎯 주요 목적
- 토큰 만료 에러 방지 및 자동 재발급(Refresh) 패턴 고도화
- API 분당/일일 호출 제한(Rate Limit) 준수를 위한 딜레이 및 백오프(Backoff) 전략 적용
- 일관된 외부 요청 에러 핸들링 및 로깅 체계 구축

## 🚀 실행 지침

1. **인증(토큰) 관리 패턴**
   - OAuth 2.0 또는 Access Token 기반 인증의 경우, 매 요청마다 하드코딩된 토큰을 쓰지 않습니다.
   - 내부 캐싱 시스템 혹은 DB, 임시 파일 단위로 토큰과 만료 시간(Expirations)을 저장하고, 만료되기 5~10분 전이거나 인증 에러(401 Unauthorized) 발생 시 자동으로 재발급 로직을 유발하는 인터셉터(Interceptor) 패턴을 의무 적용합니다.

2. **Rate Limit 모니터링 및 방어**
   - DART 및 KIS와 같은 외부 기관 API는 분당/초당 호출 횟수 오버 시 장시간 밴(Ban) 당할 위험이 있습니다.
   - 요청 루프 내에 명시적인 `sleep()` 이나 비동기 딜레이(예: `await asyncio.sleep(0.5)`)를 도입하여 제한 속도를 강제로 맞춥니다.
   - 응답 헤더의 `X-RateLimit-Remaining` 같은 필드를 스크립트에서 파싱하여, 자원이 소진될 경우 스레드를 대기시키도록 설계합니다.

3. **에러 핸들링 스키마**
   - 외부 API에서 200 OK가 아닌 4xx, 5xx 에러가 반환될 경우 어플리케이션 전체가 패닉에 빠지지 않도록 합니다.
   - Try-Catch 래핑을 하여, [API 명 / Status / 에러 본문] 을 로깅하고 다음 작업으로 우회하거나 부분 실패 처리 후 지속 진행할 수 있도록 설계합니다. (재시도 로직 - Exponential Backoff 포함 권장)

4. **검증**
   - 외부 API 연동 코드를 구현한 뒤에는 가상 혹은 Mock 환경 대신 실제 환경에 안전한 최소 요청 1회를 전송해보아 정상 응답(200 OK)이 돌아오는지 콘솔 상에서 직접 `run_command`로 확인합니다.
